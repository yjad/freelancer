from tkinter import END
from tabulate import tabulate
from DB import query_to_list
from reports import OUT_FOLDER
from openpyxl import Workbook
from tkinter import messagebox
import textwrap
import os

def wrap(string, lenght=15):
    return '\n'.join(textwrap.wrap(string, lenght))
    
def print_query(cmd,  output, title, max_len=30, export=False):
    # print ("type of cmd: ", type(cmd), export)
    if type(cmd) == str:
        header, rows = query_to_list(cmd)
    else:
        header, rows = cmd()        # a function that returns header & rows
        # print ("return back from cmd,", len(rows), "\n", rows)

    if not export:
        if max_len:     # wrap long fields at 30 chars
            new_rows = []
            for i,r in enumerate(rows):
                w_row = []
                for j, c in enumerate(r):
                    if len (str(c)) > max_len:
                        w_row.append(wrap(c, max_len))
                    else:
                        w_row.append(c)
                new_rows.append(w_row)

            table = tabulate(new_rows, headers=header, showindex="always")
        else:
            table = tabulate(rows, headers=header, showindex="always")
            
        output.delete(0.0, END)        # clear window
        output.insert(END, title+ '\n\n')
        for line in table:
            output.insert(END, line)
    else:   # export to excel
        if not os.path.exists(OUT_FOLDER):
            messagebox.showinfo("Error", f"Folder does not exist: {OUT_FOLDER}")
            return -1

        wb = Workbook()
        ws = wb.active
        ws.title = title
        ws.append(header)

        for row in rows:
            ws.append(row)
        file_name = os.path.join(OUT_FOLDER, title+".xlsx")
        try:
            wb.save(os.path.join(file_name))
        except:
            print ("error saving to excel file: ", file_name)

        messagebox.showinfo("Done!",f"file exported {file_name}! ")
    