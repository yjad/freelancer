import os
from DB import  query_to_excel, query_to_tk
OUT_FOLDER = r"C:\Users\yahia\Documents\out"

def stats_by_ip(tk_output=None):
    cmd = f""" select vlan_group, location, name,ipaddress,
	COUNT(CASE WHEN risk = 'High' Then 1 END) as 'High', 
	COUNT(CASE WHEN risk = 'Medium' Then 1 END) as 'Medium',
	COUNT(CASE WHEN risk = 'Low' Then 1 END) as 'Low',
	COUNT(CASE WHEN risk = 'Warning' Then 1 END) as 'Warning',
	COUNT(risk) as "Total"
    FROM vulnerability LEFT JOIN vlan on name = vlan
    GROUP by vlan_group, location, name, ipaddress"""   
    
    query_to_tk(cmd, tk_output)
    query_to_excel(cmd, os.path.join(OUT_FOLDER, "stats_by_ip.xlsx"))

def vulners_list_all(tk_output=None):
    cmd  = """ select Location, vlan_group, name,ipaddress, vulnerability, risk 
    FROM vulnerability LEFT JOIN vlan on name = vlan
    ORDER BY 1,2,3,4"""
    query_to_tk(cmd, tk_output)
    query_to_excel(cmd, os.path.join(OUT_FOLDER, "vulners_list_all.xlsx"))
    
    
def stats_by_group(tk_output=None):
    cmd = f""" select  vlan_group, location,
	COUNT(CASE WHEN risk = 'High' Then 1 END) as 'High', 
	COUNT(CASE WHEN risk = 'Medium' Then 1 END) as 'Medium',
	COUNT(CASE WHEN risk = 'Low' Then 1 END) as 'Low',
	COUNT(CASE WHEN risk = 'Warning' Then 1 END) as 'Warning',
	COUNT(risk) as "Total", 
    COUNT(distinct ipaddress) as "numHosts"
    FROM vulnerability LEFT JOIN vlan on name = vlan
    GROUP by location, vlan_group
    ORDER BY 1,2"""   
    
    query_to_tk(cmd, tk_output)
    query_to_excel(cmd, os.path.join(OUT_FOLDER, "stats_by_group.xlsx"))
    
    
def SAN_stats(file_name):
    cmd = f""" select name,ipaddress, assetName, 
	COUNT(CASE WHEN risk = 'High' Then 1 END) as 'High', 
	COUNT(CASE WHEN risk = 'Medium' Then 1 END) as 'Medium',
	COUNT(CASE WHEN risk = 'Low' Then 1 END) as 'Low',
	COUNT(CASE WHEN risk = 'Warning' Then 1 END) as 'Warning',
	COUNT(risk) as "Total"
    FROM vulnerability
    WHERE name LIKE '%SAN%'
    GROUP by name"""
    query_to_excel(cmd, file_name)
    
 
def VLAN_stats(file_name):
    cmd = f"""select name,count(distinct ipaddress) as "# of hosts",
	COUNT(CASE WHEN risk = 'High' Then 1 END) as 'High', 
	COUNT(CASE WHEN risk = 'Medium' Then 1 END) as 'Medium',
	COUNT(CASE WHEN risk = 'Low' Then 1 END) as 'Low',
	COUNT(CASE WHEN risk = 'Warning' Then 1 END) as 'Warning',
	COUNT(risk) as "Total"
    FROM vulnerability
    GROUP by name"""
    query_to_excel(cmd, file_name)
    
    
def Windows_and_Krom_stats(file_name):
    cmd = f"""select name
    FROM vulnerability
    WHERE name LIKE '%Windows%' or name like "%krom% or name like "internet"
    GROUP by name"""
    query_to_excel(cmd, file_name)
    

    
    

