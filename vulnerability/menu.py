# from tkinter import Tk, Label, Button, Entry, IntVar, END, W, E, NE, StringVar, DoubleVar, WORD, Menu
from tkinter import filedialog
import os
from tkinter.scrolledtext import ScrolledText
import tkinter as tk
# from tkinter import messagebox
# from tkinter.ttk import *
from reports import vulners_list_all_cmd, stats_by_group_cmd, stats_by_ip_cmd, show_scan_progress
from load_db import load_db, excel_to_csv_file
from DB import query_to_excel
from print_text_table import print_query
from increment_scan import load_increment_scan_result

    
# DATA_FOLDER=r"C:\Users\yahia\Documents\Vulner project\Qradar\09-2020 - Copy"
OUT_FOLDER = r"C:\Users\yahia\Documents\out"

def run_menu():
    root = tk.Tk()
    #root.attributes('-fullscreen', True)
    root.state('zoomed')
    
    output = ScrolledText(root, width=160, height = 40, wrap = tk.WORD, background = 'white')
    output.grid(row=1, column = 0, columnspan = 2, sticky = 'W')
    
    
    menu_bar = tk.Menu(root)
    file_menu = tk.Menu(menu_bar, tearoff=0)
    # file_menu.add_command(label="Load Qradar files", command=lambda: load_db(DATA_FOLDER, output))
    file_menu.add_command(label="Load Qradar files", command= lambda:mnu_load_db(output))
    file_menu.add_separator()
    file_menu.add_command(label="Load incremenatal scan file", command=load_increment_scan)
    file_menu.add_command(label="Excel to csv Qradar", command= lambda:mnu_excel_to_csv(output))
    file_menu.add_separator()
    file_menu.add_command(label="Exit", command=root.quit)
    menu_bar.add_cascade(label="Load", menu=file_menu)
    
    report_menu = tk.Menu(menu_bar, tearoff = 0)
    report_menu.add_command(label="Stats by ip", command= lambda: print_query(stats_by_ip_cmd, output, "Stats by IP"))
    report_menu.add_command(label="Vulnerability All", command= lambda: print_query(vulners_list_all_cmd, output, "Vulnerability All" ))
    report_menu.add_command(label="Stats by Group", command= lambda: print_query(stats_by_group_cmd, output, "Stats by VLAN Group" ))
    report_menu.add_command(label="Show Scan Progress", command= lambda: print_query(show_scan_progress, output, "Show Scan Progress" ))
    menu_bar.add_cascade(label="Reports", menu=report_menu)

    
    export_menu = tk.Menu(menu_bar, tearoff = 0)
    export_menu.add_command(label="Stats by ip", 
        command= lambda: query_to_excel(stats_by_ip_cmd, os.path.join(OUT_FOLDER, "stats_by_ip.xlsx")))
    export_menu.add_command(label="Vulnerability All", 
        command= lambda: query_to_excel(vulners_list_all_cmd, os.path.join(OUT_FOLDER, "vulners_list_all.xlsx")))
    export_menu.add_command(label="Stats by VLAN Group", 
        command= lambda: query_to_excel(stats_by_group_cmd, os.path.join(OUT_FOLDER, "stats_by_group.xlsx")))
    export_menu.add_command(label="Scan Progress", 
        command= lambda: show_scan_progress(export=True))
    menu_bar.add_cascade(label="Export", menu=export_menu)

    root.config(menu=menu_bar)    
        
    root.mainloop()


def load_increment_scan():
    try:
        file_path = tk.filedialog.askopenfilename(title="Select file",multiple=True,
                                           filetypes=(("Excel files", "*,xlsx"), ("Excel files", "*.xlsx")))
    except:
        tk.messagebox.showinfo("No File", "No file selected ...")
        return None
    
    load_increment_scan_result(file_path)
    tk.messagebox.showinfo("Info!", "file loaded successfully ....")
    
    
def mnu_load_db(output):
    r = tk.messagebox.askyesno("Confirm", "Reload all vulneabilities files?")
    if r:
        data_folder = tk.filedialog.askdirectory(initialdir=".", title="select data folder", mustexist =True)
        load_db(data_folder, output)
        
def mnu_excel_to_csv(output):
    file_path = tk.filedialog.askopenfilename(title="Select File",
                                           filetypes=(("Excel files", "*,xlsx"), ("Excel files", "*.xlsx")))
    if file_path:
        excel_to_csv_file(file_path)
    tk.messagebox.showinfo("OK", "file converted")
    
