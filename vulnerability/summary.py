import os
import csv
from openpyxl import Workbook, load_workbook


#DATA_FOLDER=r"C:\Yahia\HDB\DTS\2- Projects\Vulnerability\3-Execution\Qradar\09-2020\Microsoft-Servers"
#DATA_FOLDER=r"C:\Yahia\HDB\DTS\2- Projects\Vulnerability\3-Execution\Qradar\09-2020\QRadar-Vulnerabilities-AIX-Servers"
#DATA_FOLDER = r"C:\Yahia\HDB\DTS\2- Projects\Vulnerability\3-Execution\Qradar\09-2020\QRadar-Vulnerabilities-Network & Security"
DATA_FOLDER = r"C:\Yahia\HDB\DTS\2- Projects\Vulnerability\3-Execution\Qradar\09-2020\QRadar-Vulnerabilities-SAN"

OUT_FOLDER = r"C:\Users\yahia\Documents\out"

full_header = ["name","sequenceNumber","scanresultid","criticalDetails","severity","status","active","duration",
              "concern","startTime","vulnerabilities","numHosts","solution","ipaddress","assetName","vulnerabilityInstances","risk",
              "vulnid","openServices","description","scanProfileId","cancelled","runSchedule","vulnerability","cveid",
              "exposureId","score","domainName"]

def load_header_idx(header):
    header_idx= [-1] * len(full_header)

    for i, col in enumerate(header):
        if col.value:
            x = full_header.index(col.value)
            if x != -1:
                header_idx[i] = x
    return header_idx

def summary():
    wb_master = Workbook()
    ws_master = wb_master.active

    line = ["name", "vulnerabilities", "numHosts", "High risk", "Mid risk", "Low risk"]
    ws_master.append(line)
    for folder, subs, files in os.walk(DATA_FOLDER):
        for f in files:
            filename, file_extension = os.path.splitext(f)
            #print("----- opening ------>",filename)
            if file_extension != ".xlsx":
                continue
            xl_wb = load_workbook(os.path.join(os.path.join(folder, f)))
            line=[]
            high_risk = 0
            mid_risk = low_risk = high_risk
            for sheet in xl_wb:  # use first sheet
                for l, row in enumerate(sheet.rows):
                    if l == 0:  # load header
                        header_idx = load_header_idx(row)
                        continue

                    risk = row[Risk].value #if header_idx[Risk]             #risk
                    if risk == "High":
                        high_risk += 1
                    elif risk == "Medium":
                        mid_risk += 1
                    elif risk == "Low":
                        low_risk += 1


                line.append(high_risk)
                line.append(mid_risk)
                line.append(low_risk)

                # print(os.path.join(folder, f))
                ws_master.append(line)
    wb_master.save(r".\summary.xlsx")


def mini_all():
    wb_master = Workbook()
    ws_master = wb_master.active

    line = ["name", "ipaddress", "assetName", "risk"]
    ws_master.append(line)

    for folder, subs, files in os.walk(DATA_FOLDER):
        for f in files:
            filename, file_extension = os.path.splitext(f)
            if file_extension != ".xlsx":
                continue
            print(filename)
            xl_wb = load_workbook(os.path.join(os.path.join(folder, f)))
            for sheet in xl_wb:  # use first sheet
                Name = IPaddress = AssetName = Risk = -1
                for l, row in enumerate(sheet.rows):
                    if l == 0:  # load header
                        for i, cell in enumerate(row):
                            x = cell.value
                            if x == "name":
                                Name = i
                            elif x == "ipaddress":
                                IPaddress = i
                            elif x == "assetName":
                                AssetName = i
                            elif x == "risk":
                                Risk = i
                        print (Name, IPaddress, AssetName, Risk)
                    else:
                        line = ["",'', '', '']
                        for i, cell in enumerate(row):
                            x = cell.value
                            if i == Name:
                                line[0]= cell.value
                            elif i == IPaddress:
                                line[1]=cell.value
                            elif i == AssetName:
                                line[2]= cell.value
                            elif i == Risk:
                                line[3]= cell.value
                        ws_master.append(line)
    wb_master.save(r".\mini_all.xlsx")


def combine_all():
    wb_master = Workbook()
    ws_master = wb_master.active

    ws_master.append(full_header)

    for folder, subs, files in os.walk(DATA_FOLDER):
        for f in files:
            filename, file_extension = os.path.splitext(f)
            print(filename)
            if file_extension != ".xlsx":
                continue
            xl_wb = load_workbook(os.path.join(os.path.join(folder, f)))
            for sheet in xl_wb:  # use first sheet
                for l, row in enumerate(sheet.rows):
                    if l == 0:  # skip header
                        header_idx = load_header_idx(row)
                        print (filename, header_idx)
                    else:
                        if filename == 'HQ-VLAN-87-Windows-Internet-Banking-Test-CM-FULL':
                            y = 10
                        line = [''] * len(full_header)
                        for i, cell in enumerate(row):
                            line[header_idx[i]] = cell.value
                        ws_master.append(line)


    wb_master.save(r".\full.xlsx")

def check_header():
    wb_master = Workbook()
    ws_master = wb_master.active

    ws_master.append(full_header)

    for folder, subs, files in os.walk(DATA_FOLDER):
        for f in files:
            filename, file_extension = os.path.splitext(f)
            if file_extension != ".xlsx":
                continue
            xl_wb = load_workbook(os.path.join(os.path.join(folder, f)))
            for sheet in xl_wb:
                #for l, row in enumerate(sheet.rows):
                for l, row in enumerate(sheet.rows):
                    if l == 0:  # check header
                        line=[filename]
                        for i,cell in enumerate(row):
                            line.append(cell.value)
                        print (line)
                        break
                    else:
                        break


def combine_csv():

    csv_header = ["name","sequenceNumber","scanresultid","criticalDetails","severity","status","active","duration",
              "concern","startTime","vulnerabilities","numHosts","solution","ipaddress","assetName","vulnerabilityInstances","risk",
              "vulnid","openServices","description","scanProfileId","cancelled","runSchedule","vulnerability","cveid","exposureId","score","domainName"]
    wb_master = Workbook()
    ws_master = wb_master.active

    ws_master.append(csv_header)
    for folder, subs, files in os.walk(DATA_FOLDER):
        for f in files:
            filename, file_extension = os.path.splitext(f)
            if file_extension != ".csv":
                continue
            print(filename)
            with open(os.path.join(os.path.join(folder, f))) as csv_file:
                csv_reader = csv.reader(csv_file, delimiter=',')
                for row in csv_reader:
                    if row[0] != 'name':        # not a header
                        ws_master.append(row)
    wb_master.save(r".\csv_full.xlsx")

def load_all_csv():

    csv_header = ["name","sequenceNumber","scanresultid","criticalDetails","severity","status","active","duration",
              "concern","startTime","vulnerabilities","numHosts","solution","ipaddress","assetName","vulnerabilityInstances","risk",
              "vulnid","openServices","description","scanProfileId","cancelled","runSchedule","vulnerability","cveid","exposureId","score","domainName"]
    
    conn, cursor = open_db()
    create_tables(cursor) 
    
    # wb_master = Workbook()
    # ws_master = wb_master.active

    # ws_master.append(csv_header)
    for folder, subs, files in os.walk(DATA_FOLDER):
        for f in files:
            filename, file_extension = os.path.splitext(f)
            if file_extension != ".csv":
                continue
            print(filename)
            with open(os.path.join(os.path.join(folder, f))) as csv_file:
                csv_reader = csv.reader(csv_file, delimiter=',')
                for row in csv_reader:
                    if row[0] != 'name':        # not a header
                        ws_master.append(row)
    wb_master.save(r".\csv_full.xlsx")
    
    


